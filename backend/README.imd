# ğŸ”§ Backend ERP MÃ³viles

API REST modular para la gestiÃ³n de reparaciones, ventas y compras de dispositivos mÃ³viles.

## ğŸ“‹ Tabla de Contenidos

- [CaracterÃ­sticas](#caracterÃ­sticas)
- [TecnologÃ­as](#tecnologÃ­as)
- [Estructura del Proyecto](#estructura-del-proyecto)
- [InstalaciÃ³n](#instalaciÃ³n)
- [ConfiguraciÃ³n](#configuraciÃ³n)
- [Arquitectura](#arquitectura)
- [Flujo de Datos](#flujo-de-datos)
- [API Endpoints](#api-endpoints)
- [Base de Datos](#base-de-datos)
- [Ejemplos de Uso](#ejemplos-de-uso)
- [Desarrollo](#desarrollo)
- [ContribuciÃ³n](#contribuciÃ³n)

## âœ¨ CaracterÃ­sticas

- **Arquitectura modular** con separaciÃ³n clara de responsabilidades
- **API REST** completa con operaciones CRUD
- **Manejo robusto de errores** centralizado
- **ValidaciÃ³n de datos** en mÃºltiples capas
- **Transacciones de base de datos** para operaciones complejas
- **Logging detallado** para debugging y monitoreo
- **CORS configurado** para desarrollo y producciÃ³n
- **Middleware de seguridad** con Helmet
- **Estructura escalable** para futuras funcionalidades

## ğŸ› ï¸ TecnologÃ­as

- **Node.js** v18+ - Runtime de JavaScript
- **Express.js** v4.18 - Framework web minimalista
- **MySQL** v8.0 - Base de datos relacional
- **mysql2** - Driver de MySQL para Node.js
- **dotenv** - GestiÃ³n de variables de entorno
- **cors** - Middleware para Cross-Origin Resource Sharing
- **helmet** - Middleware de seguridad
- **morgan** - Logger HTTP

## ğŸ“ Estructura del Proyecto

```
backend/
â”œâ”€â”€ ğŸ“„ server.js                    # Punto de entrada principal
â”œâ”€â”€ ğŸ“„ package.json                 # Dependencias y scripts
â”œâ”€â”€ ğŸ“„ README.md                    # DocumentaciÃ³n
â”œâ”€â”€ ğŸ“„ .env                         # Variables de entorno
â”œâ”€â”€ ğŸ“„ .gitignore                   # Archivos ignorados por Git
â”œâ”€â”€ ğŸ“‚ config/
â”‚   â”œâ”€â”€ ğŸ“„ database.js              # ConfiguraciÃ³n de base de datos
â”‚   â””â”€â”€ ğŸ“„ cors.js                  # ConfiguraciÃ³n CORS
â”œâ”€â”€ ğŸ“‚ middleware/
â”‚   â”œâ”€â”€ ğŸ“„ auth.js                  # AutenticaciÃ³n (futuro)
â”‚   â”œâ”€â”€ ğŸ“„ validation.js            # ValidaciÃ³n de datos
â”‚   â””â”€â”€ ğŸ“„ errorHandler.js          # Manejo centralizado de errores
â”œâ”€â”€ ğŸ“‚ routes/
â”‚   â”œâ”€â”€ ğŸ“„ index.js                 # Rutas principales
â”‚   â”œâ”€â”€ ğŸ“„ test.js                  # Rutas de prueba y salud
â”‚   â”œâ”€â”€ ğŸ“„ reparaciones.js          # Rutas de reparaciones
â”‚   â”œâ”€â”€ ğŸ“„ ventas.js                # Rutas de ventas
â”‚   â”œâ”€â”€ ğŸ“„ compras.js               # Rutas de compras
â”‚   â””â”€â”€ ğŸ“„ clientes.js              # Rutas de clientes
â”œâ”€â”€ ğŸ“‚ controllers/
â”‚   â”œâ”€â”€ ğŸ“„ reparacionController.js  # Controlador de reparaciones
â”‚   â”œâ”€â”€ ğŸ“„ ventaController.js       # Controlador de ventas
â”‚   â”œâ”€â”€ ğŸ“„ compraController.js      # Controlador de compras
â”‚   â””â”€â”€ ğŸ“„ clienteController.js     # Controlador de clientes
â”œâ”€â”€ ğŸ“‚ services/
â”‚   â”œâ”€â”€ ğŸ“„ reparacionService.js     # LÃ³gica de negocio - reparaciones
â”‚   â”œâ”€â”€ ğŸ“„ ventaService.js          # LÃ³gica de negocio - ventas
â”‚   â”œâ”€â”€ ğŸ“„ compraService.js         # LÃ³gica de negocio - compras
â”‚   â””â”€â”€ ğŸ“„ notificationService.js   # Servicio de notificaciones
â”œâ”€â”€ ğŸ“‚ models/
â”‚   â”œâ”€â”€ ğŸ“„ index.js                 # ExportaciÃ³n de modelos
â”‚   â”œâ”€â”€ ğŸ“‚ Reparacion/
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ReparacionModel.js   # Modelo de reparaciÃ³n
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ DispositivoModel.js  # Modelo de dispositivo
â”‚   â”‚   â””â”€â”€ ğŸ“„ AveriaModel.js       # Modelo de averÃ­a
â”‚   â”œâ”€â”€ ğŸ“‚ Venta/
â”‚   â”‚   â””â”€â”€ ğŸ“„ VentaModel.js        # Modelo de venta
â”‚   â””â”€â”€ ğŸ“‚ Cliente/
â”‚       â””â”€â”€ ğŸ“„ ClienteModel.js      # Modelo de cliente
â””â”€â”€ ğŸ“‚ utils/
    â”œâ”€â”€ ğŸ“„ validators.js            # Validadores personalizados
    â”œâ”€â”€ ğŸ“„ helpers.js               # Funciones de ayuda
    â””â”€â”€ ğŸ“„ constants.js             # Constantes del sistema
```

## ğŸš€ InstalaciÃ³n

### Prerequisitos

- Node.js v18.0.0 o superior
- MySQL v8.0 o superior
- NPM v9.0.0 o superior

### Pasos de instalaciÃ³n

1. **Clonar el repositorio**
```bash
git clone https://github.com/tu-usuario/erp-moviles.git
cd erp-moviles/backend
```

2. **Instalar dependencias**
```bash
npm install
```

3. **Configurar variables de entorno**
```bash
cp .env.example .env
```

4. **Configurar la base de datos**
```bash
# Crear la base de datos en MySQL
mysql -u root -p
CREATE DATABASE erp_moviles;
```

5. **Ejecutar migraciones** (si existen)
```bash
npm run migrate
```

6. **Iniciar el servidor**
```bash
# Desarrollo
npm run dev

# ProducciÃ³n
npm start
```

## âš™ï¸ ConfiguraciÃ³n

### Variables de Entorno

```env
# Servidor
PORT=5000
NODE_ENV=development

# Base de datos
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=tu_password
DB_NAME=erp_moviles

# Frontend
FRONTEND_URL=http://localhost:5173

# JWT (futuro)
JWT_SECRET=tu_jwt_secret
JWT_EXPIRES_IN=24h

# Email (futuro)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=tu_email@gmail.com
EMAIL_PASSWORD=tu_password
```

### Scripts disponibles

```bash
# Desarrollo con auto-reload
npm run dev

# ProducciÃ³n
npm start

# Ejecutar tests
npm test

# Linter
npm run lint

# Formatear cÃ³digo
npm run format
```

## ğŸ—ï¸ Arquitectura

### PatrÃ³n MVC Modular

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Routes      â”‚â”€â”€â”€â”€â”‚   Controllers   â”‚â”€â”€â”€â”€â”‚    Services     â”‚
â”‚  (HTTP Layer)   â”‚    â”‚  (Logic Layer)  â”‚    â”‚ (Business Logic)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚     Models      â”‚
                                               â”‚  (Data Layer)   â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚    Database     â”‚
                                               â”‚     (MySQL)     â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Capas de la AplicaciÃ³n

1. **Rutas (Routes)**: Definen endpoints HTTP y validan parÃ¡metros
2. **Controladores (Controllers)**: Manejan requests/responses y coordinan operaciones
3. **Servicios (Services)**: Contienen lÃ³gica de negocio y transacciones
4. **Modelos (Models)**: AbstracciÃ³n de datos y operaciones de BD
5. **Middleware**: Funciones que procesan requests (auth, validation, error handling)

## ğŸ”„ Flujo de Datos

### Flujo de una PeticiÃ³n HTTP

```mermaid
graph TD
    A[Cliente HTTP] --> B[Express Server]
    B --> C[Middleware Global]
    C --> D[Route Handler]
    D --> E[Controller]
    E --> F[Service]
    F --> G[Model]
    G --> H[Database]
    H --> I[Response]
    I --> J[Error Handler]
    J --> K[Cliente HTTP]
```

### Ejemplo: Crear una ReparaciÃ³n

```javascript
// 1. Request llega a la ruta
POST /api/reparaciones/crear-completa

// 2. Route handler valida y llama al controller
router.post('/crear-completa', reparacionController.crearReparacionCompleta);

// 3. Controller procesa el request
const resultado = await reparacionService.crearReparacionCompleta(data);

// 4. Service ejecuta la lÃ³gica de negocio
async crearReparacionCompleta(data) {
  // TransacciÃ³n de base de datos
  // Validaciones de negocio
  // Operaciones mÃºltiples
}

// 5. Response al cliente
res.json({
  success: true,
  data: resultado,
  timestamp: new Date().toISOString()
});
```

## ğŸ”Œ API Endpoints

### Rutas de Salud y Pruebas

| MÃ©todo | Endpoint | DescripciÃ³n |
|--------|----------|-------------|
| GET | `/api/health` | Estado del servidor |
| GET | `/api/test-db` | Prueba de conexiÃ³n BD |
| GET | `/api/database/stats` | EstadÃ­sticas de tablas |
| GET | `/api/establecimientos` | Lista de establecimientos |

### Rutas de Reparaciones

| MÃ©todo | Endpoint | DescripciÃ³n |
|--------|----------|-------------|
| GET | `/api/reparaciones` | Lista de reparaciones |
| GET | `/api/reparaciones/:id` | ReparaciÃ³n especÃ­fica |
| GET | `/api/reparaciones/resumen` | Resumen usando vista |
| GET | `/api/reparaciones/stats/dashboard` | EstadÃ­sticas |
| POST | `/api/reparaciones/crear-completa` | Crear reparaciÃ³n completa |
| PATCH | `/api/reparaciones/:id/estado` | Actualizar estado |
| DELETE | `/api/reparaciones/:id` | Eliminar reparaciÃ³n |

### Rutas de Clientes

| MÃ©todo | Endpoint | DescripciÃ³n |
|--------|----------|-------------|
| GET | `/api/clientes` | Lista de clientes |
| POST | `/api/clientes/test` | Crear cliente de prueba |

### Rutas de Ventas (En desarrollo)

| MÃ©todo | Endpoint | DescripciÃ³n |
|--------|----------|-------------|
| GET | `/api/ventas` | Lista de ventas |

### Rutas de Compras (En desarrollo)

| MÃ©todo | Endpoint | DescripciÃ³n |
|--------|----------|-------------|
| GET | `/api/compras` | Lista de compras |

## ğŸ—„ï¸ Base de Datos

### Esquema Principal

```sql
-- Tablas principales
establecimientos
clientes
reparaciones
reparacion_dispositivos
dispositivo_averias
averia_servicios
reparacion_pagos
reparacion_historial
cliente_comunicaciones
```

### Relaciones

```
establecimientos (1) -----> (N) clientes
clientes (1) -----> (N) reparaciones
reparaciones (1) -----> (N) reparacion_dispositivos
reparacion_dispositivos (1) -----> (N) dispositivo_averias
dispositivo_averias (1) -----> (N) averia_servicios
reparaciones (1) -----> (N) reparacion_pagos
reparaciones (1) -----> (N) reparacion_historial
```

### Estados de ReparaciÃ³n

```javascript
const ESTADOS_REPARACION = {
  INICIADA: 'iniciada',
  EN_DIAGNOSTICO: 'en_diagnostico',
  ESPERANDO_APROBACION: 'esperando_aprobacion',
  PARCIALMENTE_APROBADA: 'parcialmente_aprobada',
  EN_EJECUCION: 'en_ejecucion',
  PARCIALMENTE_LISTA: 'parcialmente_lista',
  LISTA: 'lista',
  ENTREGADA: 'entregada',
  SUSPENDIDA: 'suspendida',
  CANCELADA: 'cancelada'
};
```

## ğŸ“š Ejemplos de Uso

### Crear una ReparaciÃ³n Completa

```javascript
// POST /api/reparaciones/crear-completa
const reparacionData = {
  clienteData: {
    nombre: "Juan",
    apellidos: "PÃ©rez",
    dni: "12345678A",
    telefono: "666123456",
    email: "juan@email.com"
  },
  dispositivoData: {
    marca: "iPhone",
    modelo: "14 Pro",
    imei: "123456789012345",
    color: "Azul",
    capacidad: "128GB"
  },
  diagnosticoData: {
    problemas_reportados: ["Pantalla rota", "BaterÃ­a agotada"],
    prioridad: "normal",
    sintomas_adicionales: "El dispositivo no enciende"
  },
  presupuestoData: {
    items: [
      {
        concepto: "Cambio de pantalla",
        tipo: "repuesto",
        cantidad: 1,
        precio: 200
      },
      {
        concepto: "Cambio de baterÃ­a",
        tipo: "repuesto",
        cantidad: 1,
        precio: 80
      }
    ],
    descuento: 10,
    tipo_descuento: "porcentaje"
  }
};

const response = await fetch('/api/reparaciones/crear-completa', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(reparacionData)
});
```

### Obtener Lista de Reparaciones

```javascript
// GET /api/reparaciones?estado=en_diagnostico&busqueda=iPhone
const response = await fetch('/api/reparaciones?estado=en_diagnostico&busqueda=iPhone');
const data = await response.json();

console.log(data);
// {
//   success: true,
//   data: [
//     {
//       id: 1,
//       numero_orden: "R-2025-0001",
//       cliente_nombre: "Juan",
//       cliente_apellidos: "PÃ©rez",
//       estado_general: "en_diagnostico",
//       dispositivos_lista: "iPhone 14 Pro",
//       total_final: 252.00,
//       total_dispositivos: 1,
//       total_averias: 2,
//       averias_completadas: 0
//     }
//   ],
//   count: 1,
//   timestamp: "2025-01-14T..."
// }
```

### Manejo de Errores

```javascript
// Ejemplo de respuesta de error
{
  success: false,
  message: "Error en la base de datos",
  error: "ER_DUP_ENTRY: Duplicate entry...",
  timestamp: "2025-01-14T10:30:00.000Z"
}
```

## ğŸ”§ Desarrollo

### Agregar un Nuevo MÃ³dulo

1. **Crear las rutas**
```javascript
// routes/productos.js
const express = require('express');
const router = express.Router();
const productoController = require('../controllers/productoController');

router.get('/', productoController.obtenerProductos);
router.post('/', productoController.crearProducto);

module.exports = router;
```

2. **Crear el controlador**
```javascript
// controllers/productoController.js
const productoService = require('../services/productoService');

const productoController = {
  obtenerProductos: async (req, res, next) => {
    try {
      const productos = await productoService.obtenerTodos();
      res.json({ success: true, data: productos });
    } catch (error) {
      next(error);
    }
  }
};

module.exports = productoController;
```

3. **Crear el servicio**
```javascript
// services/productoService.js
const { executeQuery } = require('../config/database');

const productoService = {
  obtenerTodos: async () => {
    return await executeQuery('SELECT * FROM productos');
  }
};

module.exports = productoService;
```

4. **Registrar en server.js**
```javascript
const productoRoutes = require('./routes/productos');
app.use('/api/productos', productoRoutes);
```

### Buenas PrÃ¡cticas

- **Usar transacciones** para operaciones complejas
- **Validar datos** en mÃºltiples capas
- **Manejar errores** de forma consistente
- **Separar responsabilidades** claramente
- **Documentar** cambios importantes
- **Usar async/await** en lugar de callbacks
- **Implementar logging** detallado

### Testing

```javascript
// tests/reparaciones.test.js
const request = require('supertest');
const app = require('../server');

describe('Reparaciones API', () => {
  test('GET /api/reparaciones', async () => {
    const response = await request(app)
      .get('/api/reparaciones')
      .expect(200);
    
    expect(response.body.success).toBe(true);
    expect(Array.isArray(response.body.data)).toBe(true);
  });
});
```

### Debugging

```javascript
// Habilitar logging detallado
DEBUG=erp:* npm run dev

// Logs en servicios
console.log('ğŸ“‹ Procesando reparaciÃ³n:', data);
console.log('âœ… ReparaciÃ³n creada:', resultado);
console.error('âŒ Error:', error);
```

## ğŸ“ Logging

### Niveles de Log

- **ğŸ“‹ INFO**: InformaciÃ³n general (azul)
- **âœ… SUCCESS**: Operaciones exitosas (verde)
- **âš ï¸ WARNING**: Advertencias (amarillo)
- **âŒ ERROR**: Errores (rojo)
- **ğŸ” DEBUG**: InformaciÃ³n de debug (gris)

### Ejemplos

```javascript
console.log('ğŸ“‹ Iniciando servidor...');
console.log('âœ… ConexiÃ³n a BD establecida');
console.warn('âš ï¸ ParÃ¡metro faltante, usando valor por defecto');
console.error('âŒ Error en la transacciÃ³n:', error);
```

## ğŸš€ Deployment

### ProducciÃ³n

```bash
# Instalar dependencias de producciÃ³n
npm ci --only=production

# Construir aplicaciÃ³n
npm run build

# Iniciar con PM2
pm2 start ecosystem.config.js

# Configurar variables de entorno
export NODE_ENV=production
export DB_HOST=tu_servidor_mysql
export DB_PASSWORD=tu_password_seguro
```

### Docker

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 5000

CMD ["npm", "start"]
```

## ğŸ¤ ContribuciÃ³n

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

### Convenciones de CÃ³digo

- **Nomenclatura**: camelCase para variables y funciones
- **Archivos**: camelCase para archivos JavaScript
- **Constantes**: UPPER_SNAKE_CASE
- **Comentarios**: Explicar el "por quÃ©", no el "quÃ©"
- **Commits**: Usar convenciones de [Conventional Commits](https://www.conventionalcommits.org/)

## ğŸ“„ Licencia

Este proyecto estÃ¡ bajo la Licencia MIT - ver el archivo [LICENSE](LICENSE) para mÃ¡s detalles.

## ğŸ“ Contacto

- **Proyecto**: ERP MÃ³viles
- **Autor**: Tu Nombre
- **Email**: tu@email.com
- **GitHub**: https://github.com/tu-usuario/erp-moviles

---

**Â¡Gracias por usar ERP MÃ³viles!** ğŸ‰